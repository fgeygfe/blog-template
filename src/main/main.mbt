///| æ¶ˆæ¯ç±»å‹ - æ‰©å±•äº†æ›´å¤šäº¤äº’åŠŸèƒ½
enum Msg {
  ToHome
  ToPost1
  ToPost2
  ToPost3
  ToPost4
  ToAbout
  Search(String)
  SelectTag(String)
  ToggleTheme
  LikePost(Int)
  SharePost(Int)
  LoadMorePosts
  ToggleMenu
}
///| çŠ¶æ€ç±»å‹ - æ·»åŠ äº†ä¸»é¢˜ã€èœå•çŠ¶æ€ç­‰
struct Model {
  page : Int // 0:é¦–é¡µ, 1-4:è¯¦æƒ…é¡µ, 5:å…³äºé¡µ
  search : String
  tag : String
  dark_theme : Bool
  menu_open : Bool
  liked_posts : Array[Int]
  posts_per_page : Int
  current_posts_count : Int
}
///| åšå®¢æ–‡ç« ç»“æ„ - æ·»åŠ äº†æ›´å¤šå­—æ®µ
struct Post {
  id: Int
  emoji: String
  title: String
  author: String
  date: String
  summary: String
  content: String
  tag: String
  likes: Int
  read_time: String
  click: Msg
}
///| æ›´æ–°å‡½æ•° - å¤„ç†æ–°å¢çš„æ¶ˆæ¯ç±»å‹
fn update(msg : Msg, model : Model) -> (Cmd[Msg], Model) {
  match msg {
    ToHome => (none(), { ..model, page: 0, menu_open: false })
    ToPost1 => (none(), { ..model, page: 1, menu_open: false })
    ToPost2 => (none(), { ..model, page: 2, menu_open: false })
    ToPost3 => (none(), { ..model, page: 3, menu_open: false })
    ToPost4 => (none(), { ..model, page: 4, menu_open: false })
    ToAbout => (none(), { ..model, page: 5, menu_open: false })
    Search(keyword) => (none(), { ..model, page: 0, search: keyword })
    SelectTag(tag) => (none(), { ..model, page: 0, tag: tag })
    ToggleTheme => (none(), { ..model, dark_theme: !model.dark_theme })
    ToggleMenu => (none(), { ..model, menu_open: !model.menu_open })
    LikePost(id) => {
      if model.liked_posts.contains(id) {
        model.liked_posts.retain(fn(x) { x != id })
      } else {
        model.liked_posts.push(id)
      }
      (none(), model)
    }
    SharePost(_id) => (none(), model) // å¯ä»¥æ·»åŠ åˆ†äº«é€»è¾‘
    LoadMorePosts => (none(), { ..model, current_posts_count: model.current_posts_count + model.posts_per_page })
  }
}
///| è·å–æ‰€æœ‰åšå®¢æ–‡ç« 
fn get_all_posts() -> Array[Post] {
  [
    {
      id: 1,
      emoji: "ğŸ‘©â€ğŸ’»", 
      title: "MoonBit åšå®¢ç³»ç»Ÿå¼€å‘åˆæ¢",
      author: "Zhuanz2",
      date: "2025-01-20",
      summary: "æ¢ç´¢ä½¿ç”¨ MoonBit å’Œ rabbit-tea æ¡†æ¶æ„å»ºç°ä»£åŒ–åšå®¢ç³»ç»Ÿçš„æœ€ä½³å®è·µã€‚",
      content: "åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨å¦‚ä½•ä½¿ç”¨ MoonBit è¯­è¨€å’Œ rabbit-tea æ¡†æ¶æ¥æ„å»ºä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„åšå®¢ç³»ç»Ÿ...",
      tag: "MoonBit",
      likes: 42,
      read_time: "5 åˆ†é’Ÿ",
      click: ToPost1
    },
    {
      id: 2,
      emoji: "ğŸ¦„",
      title: "Rabbit-tea æ¡†æ¶æ·±åº¦è§£æ", 
      author: "Yoorkin",
      date: "2025-01-18",
      summary: "Rabbit-tea æ˜¯ MoonBit ç”Ÿæ€ä¸­çš„å‰ç«¯æ¡†æ¶ï¼Œé‡‡ç”¨ TEA æ¶æ„æ¨¡å¼ï¼Œé€‚åˆæ„å»ºå¯ç»´æŠ¤çš„ Web åº”ç”¨ã€‚",
      content: "Rabbit-tea æ¡†æ¶åŸºäº The Elm Architecture (TEA) è®¾è®¡æ¨¡å¼ï¼Œæä¾›äº†ä¸€ç§å‡½æ•°å¼çš„æ–¹å¼æ¥æ„å»ºç”¨æˆ·ç•Œé¢...",
      tag: "å‰ç«¯",
      likes: 38,
      read_time: "8 åˆ†é’Ÿ",
      click: ToPost2
    },
    {
      id: 3,
      emoji: "ğŸš€",
      title: "WebAssembly åœ¨ç°ä»£ Web å¼€å‘ä¸­çš„åº”ç”¨",
      author: "DevExpert",
      date: "2025-01-15",
      summary: "WebAssembly æ­£åœ¨æ”¹å˜ Web å¼€å‘çš„æ¸¸æˆè§„åˆ™ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åœ¨é¡¹ç›®ä¸­æœ‰æ•ˆåˆ©ç”¨è¿™é¡¹æŠ€æœ¯ã€‚",
      content: "WebAssembly (WASM) æ˜¯ä¸€ç§æ–°çš„ç¼–ç æ–¹å¼ï¼Œå¯ä»¥åœ¨ç°ä»£çš„ç½‘ç»œæµè§ˆå™¨ä¸­è¿è¡Œ...",
      tag: "WebAssembly",
      likes: 56,
      read_time: "12 åˆ†é’Ÿ",
      click: ToPost3
    },
    {
      id: 4,
      emoji: "ğŸ¨",
      title: "å‡½æ•°å¼ç¼–ç¨‹è®¾è®¡æ¨¡å¼å®æˆ˜",
      author: "FPMaster",
      date: "2025-01-12",
      summary: "é€šè¿‡å®é™…æ¡ˆä¾‹å­¦ä¹ å‡½æ•°å¼ç¼–ç¨‹çš„æ ¸å¿ƒæ¦‚å¿µå’Œè®¾è®¡æ¨¡å¼ï¼Œæå‡ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§ã€‚",
      content: "å‡½æ•°å¼ç¼–ç¨‹ä¸ä»…ä»…æ˜¯ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œæ›´æ˜¯ä¸€ç§æ€ç»´æ–¹å¼...",
      tag: "ç¼–ç¨‹",
      likes: 34,
      read_time: "10 åˆ†é’Ÿ",
      click: ToPost4
    }
  ]
}
///| å¯¼èˆªæ ç»„ä»¶
fn navbar(model: Model) -> Html[Msg] {
  let theme_bg = if model.dark_theme { "bg-gray-800" } else { "bg-white" }
  let theme_text = if model.dark_theme { "text-white" } else { "text-gray-800" }
  
  div(class="fixed top-0 w-full z-50 " + theme_bg + " shadow-lg", [
    div(class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center", [
      button(
        class="text-2xl font-bold " + theme_text,
        click=ToHome,
        [text("ğŸŒ¸ MoonBit Blog")]
      ),
      div(class="hidden md:flex space-x-6", [
        button(class="hover:text-pink-500 " + theme_text, click=ToHome, [text("é¦–é¡µ")]),
        button(class="hover:text-pink-500 " + theme_text, click=ToAbout, [text("å…³äº")]),
        button(
          class="px-3 py-1 rounded-full border " + (if model.dark_theme { "border-gray-600" } else { "border-gray-300"}),
          click=ToggleTheme,
          [text(if model.dark_theme { "ğŸŒ" } else { "ğŸŒ™" })]
        )
      ]),
      button(
        class="md:hidden " + theme_text,
        click=ToggleMenu,
        [text("â˜°")]
      )
    ])
  ])
}
///| é¦–é¡µè§†å›¾ - å¢å¼ºç‰ˆ
fn view_home(model: Model) -> Html[Msg] {
  let posts = get_all_posts()
  let tags = ["å…¨éƒ¨", "MoonBit", "å‰ç«¯", "WebAssembly", "ç¼–ç¨‹"]
  
  let filtered_posts = posts.filter(fn(post) {
    (model.tag == "" || model.tag == "å…¨éƒ¨" || post.tag == model.tag) &&
    (model.search == "" || post.title.contains(model.search) || post.summary.contains(model.search))
  })

  let bg_class = if model.dark_theme { 
    "min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900" 
  } else { 
    "min-h-screen bg-gradient-to-br from-pink-200 via-pink-100 to-white" 
  }

  div(class=bg_class, [
    navbar(model),
    
    div(class="pt-20", [
      // è‹±é›„åŒºåŸŸ
      div(class="text-center py-16 px-4", [
        h1(
          class="text-6xl font-extrabold mb-4 " + (if model.dark_theme { "text-white" } else { "text-gray-800" }),
          [text("ğŸŒ¸ æ¬¢è¿æ¥åˆ° MoonBit ä¸–ç•Œ")]
        ),
        p(
          class="text-xl mb-8 " + (if model.dark_theme { "text-gray-300" } else { "text-gray-600" }),
          [text("æ¢ç´¢ç°ä»£ç¼–ç¨‹è¯­è¨€çš„é­…åŠ›ï¼Œåˆ†äº«æŠ€æœ¯è§è§£ä¸å®è·µç»éªŒ")]
        )
      ]),
      
      // æœç´¢å’Œæ ‡ç­¾åŒºåŸŸ
      div(class="max-w-4xl mx-auto px-4 mb-8", [
        div(class="flex flex-wrap gap-3 mb-6 justify-center", [
          button(
            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition",
            click=Search("MoonBit"),
            [text("ğŸ” æœç´¢: MoonBit")]
          ),
          button(
            class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition",
            click=Search("å‰ç«¯"),
            [text("ğŸ” æœç´¢: å‰ç«¯")]
          ),
          button(
            class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition",
            click=Search(""),
            [text("âœ¨ æ¸…é™¤æœç´¢")]
          )
        ]),
        
        div(
          class="flex flex-wrap gap-2 justify-center",
          tags.map(fn(tag) {
            let is_active = model.tag == tag
            let btn_class = if is_active {
              "bg-pink-500 text-white px-4 py-2 rounded-full shadow-lg"
            } else {
              let base = "px-4 py-2 rounded-full transition hover:shadow-md"
              if model.dark_theme {
                base + " bg-gray-700 text-gray-200 hover:bg-gray-600"
              } else {
                base + " bg-white text-gray-700 hover:bg-gray-100"
              }
            }
            button(
              class=btn_class,
              click=SelectTag(tag),
              [text(tag)]
            )
          })
        )
      ]),
      
      // åšå®¢åˆ—è¡¨
      div(class="max-w-4xl mx-auto px-4 pb-16", [
        if filtered_posts.length() == 0 {
          div(class="text-center py-16", [
            div(class="text-6xl mb-4", [text("ğŸ“")]),
            p(class="text-xl " + (if model.dark_theme { "text-gray-400" } else { "text-gray-500" }), [text("æš‚æ— ç›¸å…³æ–‡ç« ")])
          ])
        } else {
          div(
            class="grid gap-8 md:grid-cols-2",
            filtered_posts.map(fn(post) {
              let card_bg = if model.dark_theme { "bg-gray-800" } else { "bg-white" }
              let card_text = if model.dark_theme { "text-white" } else { "text-gray-800" }
              let is_liked = model.liked_posts.contains(post.id)
              
              div(
                class=card_bg + " rounded-xl shadow-xl p-6 hover:scale-105 transition-all duration-300 border " + 
                      (if model.dark_theme { "border-gray-700" } else { "border-gray-100" }),
                [
                  div(class="flex items-start justify-between mb-4", [
                    div(class="text-3xl", [text(post.emoji)]),
                    div(class="flex gap-2", [
                      button(
                        class="text-xl " + (if is_liked { "text-red-500" } else { "text-gray-400" }),
                        click=LikePost(post.id),
                        [text(if is_liked { "â¤ï¸" } else { "ğŸ¤" })]
                      ),
                      button(
                        class="text-xl text-gray-400 hover:text-blue-500",
                        click=SharePost(post.id),
                        [text("ğŸ”—")]
                      )
                    ])
                  ]),
                  h2(class="text-xl font-bold mb-3 " + card_text, [text(post.title)]),
                  div(class="flex items-center gap-4 text-sm text-gray-500 mb-3", [
                    text("ğŸ‘¤ " + post.author),
                    text("ğŸ“… " + post.date),
                    text("â±ï¸ " + post.read_time)
                  ]),
                  p(class="text-gray-600 mb-4 line-clamp-3", [text(post.summary)]),
                  div(class="flex justify-between items-center", [
                    div(
                      class="bg-pink-100 text-pink-700 px-3 py-1 rounded-full text-sm",
                      [text(post.tag)]
                    ),
                    button(
                      class="px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition flex items-center gap-2",
                      click=post.click,
                      [text("é˜…è¯»å…¨æ–‡"), text("â†’")]
                    )
                  ]),
                  div(class="mt-3 flex items-center gap-2 text-sm text-gray-500", [
                    text("ğŸ‘ " + post.likes.to_string() + " èµ")
                  ])
                ]
              )
            })
          )
        }
      ])
    ])
  ])
}
///| æ–‡ç« è¯¦æƒ…é¡µæ¨¡æ¿
fn view_post_detail(post: Post, model: Model) -> Html[Msg] {
  let bg_class = if model.dark_theme { "bg-gray-900" } else { "bg-gradient-to-br from-pink-100 to-white" }
  let card_bg = if model.dark_theme { "bg-gray-800" } else { "bg-white" }
  let text_color = if model.dark_theme { "text-white" } else { "text-gray-800" }
  
  div(class="min-h-screen " + bg_class, [
    navbar(model),
    div(class="pt-24 pb-16 px-4", [
      div(class="max-w-4xl mx-auto " + card_bg + " rounded-xl shadow-xl p-8", [
        div(class="flex items-center gap-4 mb-6", [
          div(class="text-4xl", [text(post.emoji)]),
          div(class="flex-1", [
            h1(class="text-3xl font-bold " + text_color, [text(post.title)]),
            div(class="flex items-center gap-4 mt-2 text-sm text-gray-500", [
              text("ğŸ‘¤ " + post.author),
              text("ğŸ“… " + post.date),
              text("â±ï¸ " + post.read_time),
              text("ğŸ‘ " + post.likes.to_string() + " èµ")
            ])
          ])
        ]),
        div(class="border-b border-gray-200 mb-8", [text("")]),
        div(class="prose prose-lg max-w-none " + text_color + " mb-8", [
          p(class="text-lg leading-relaxed", [text(post.content)])
        ]),
        div(class="flex gap-4", [
          button(
            class="px-6 py-3 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition flex items-center gap-2",
            click=ToHome,
            [text("ğŸ  è¿”å›é¦–é¡µ")]
          ),
          button(
            class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition flex items-center gap-2",
            click=LikePost(post.id),
            [text("ğŸ‘ ç‚¹èµ")]
          ),
          button(
            class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition flex items-center gap-2",
            click=SharePost(post.id),
            [text("ğŸ”— åˆ†äº«")]
          )
        ])
      ])
    ])
  ])
}
///| è¯¦æƒ…é¡µè§†å›¾å‡½æ•°
fn view_post1(model: Model) -> Html[Msg] {
  let posts = get_all_posts()
  view_post_detail(posts[0], model)
}

fn view_post2(model: Model) -> Html[Msg] {
  let posts = get_all_posts()
  view_post_detail(posts[1], model)
}

fn view_post3(model: Model) -> Html[Msg] {
  let posts = get_all_posts()
  view_post_detail(posts[2], model)
}

fn view_post4(model: Model) -> Html[Msg] {
  let posts = get_all_posts()
  view_post_detail(posts[3], model)
}
///| å…³äºé¡µé¢
fn view_about(model: Model) -> Html[Msg] {
  let bg_class = if model.dark_theme { "bg-gray-900" } else { "bg-gradient-to-br from-pink-100 to-white" }
  let card_bg = if model.dark_theme { "bg-gray-800" } else { "bg-white" }
  let text_color = if model.dark_theme { "text-white" } else { "text-gray-800" }
  
  div(class="min-h-screen " + bg_class, [
    navbar(model),
    div(class="pt-24 pb-16 px-4", [
      div(class="max-w-4xl mx-auto " + card_bg + " rounded-xl shadow-xl p-8", [
        div(class="text-center mb-8", [
          div(class="text-6xl mb-4", [text("ğŸŒ¸")]),
          h1(class="text-4xl font-bold " + text_color + " mb-4", [text("å…³äº MoonBit åšå®¢")]),
          p(class="text-xl text-gray-600", [text("æ¢ç´¢ç°ä»£ç¼–ç¨‹è¯­è¨€çš„é­…åŠ›")])
        ]),
        div(class="prose prose-lg max-w-none " + text_color, [
          h2(class="text-2xl font-bold mb-4", [text("é¡¹ç›®ä»‹ç»")]),
          p(class="mb-6 leading-relaxed", [
            text("è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ MoonBit è¯­è¨€å’Œ rabbit-tea æ¡†æ¶æ„å»ºçš„ç°ä»£åŒ–åšå®¢ç³»ç»Ÿã€‚"),
            text("é¡¹ç›®å±•ç¤ºäº†å‡½æ•°å¼ç¼–ç¨‹åœ¨å‰ç«¯å¼€å‘ä¸­çš„åº”ç”¨ï¼Œä»¥åŠ WebAssembly æŠ€æœ¯çš„å¼ºå¤§æ½œåŠ›ã€‚")
          ]),
          h2(class="text-2xl font-bold mb-4", [text("æŠ€æœ¯æ ˆ")]),
          div(class="grid md:grid-cols-2 gap-4 mb-6", [
            div(class="p-4 bg-pink-50 rounded-lg", [
              h3(class="font-bold text-pink-700", [text("ğŸš€ MoonBit")]),
              p(class="text-sm text-gray-600", [text("ç°ä»£åŒ–çš„ç¼–ç¨‹è¯­è¨€ï¼Œä¸“ä¸ºäº‘è®¡ç®—å’Œè¾¹ç¼˜è®¡ç®—è®¾è®¡")])
            ]),
            div(class="p-4 bg-blue-50 rounded-lg", [
              h3(class="font-bold text-blue-700", [text("ğŸ¦„ Rabbit-tea")]),
              p(class="text-sm text-gray-600", [text("åŸºäº TEA æ¶æ„çš„å‰ç«¯æ¡†æ¶")])
            ]),
            div(class="p-4 bg-green-50 rounded-lg", [
              h3(class="font-bold text-green-700", [text("ğŸ¨ Tailwind CSS")]),
              p(class="text-sm text-gray-600", [text("å®ç”¨ä¼˜å…ˆçš„ CSS æ¡†æ¶")])
            ]),
            div(class="p-4 bg-purple-50 rounded-lg", [
              h3(class="font-bold text-purple-700", [text("ğŸŒ WebAssembly")]),
              p(class="text-sm text-gray-600", [text("é«˜æ€§èƒ½çš„ Web è¿è¡Œæ—¶æŠ€æœ¯")])
            ])
          ])
        ]),
        div(class="text-center", [
          button(
            class="px-6 py-3 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition",
            click=ToHome,
            [text("ğŸ  è¿”å›é¦–é¡µ")]
          )
        ])
      ])
    ])
  ])
}
///| ä¸»è§†å›¾è·¯ç”±
fn view(model : Model) -> Html[Msg] {
  match model.page {
    0 => view_home(model)
    1 => view_post1(model)
    2 => view_post2(model)
    3 => view_post3(model)
    4 => view_post4(model)
    5 => view_about(model)
    _ => div(class="min-h-screen flex items-center justify-center", [
      div(class="text-center", [
        div(class="text-6xl mb-4", [text("ğŸ˜µ")]),
        h1(class="text-2xl font-bold text-gray-800 mb-4", [text("é¡µé¢æœªæ‰¾åˆ°")]),
        button(
          class="px-6 py-3 bg-pink-500 text-white rounded-lg hover:bg-pink-600",
          click=ToHome,
          [text("è¿”å›é¦–é¡µ")]
        )
      ])
    ])
  }
}
///| ä¸»å‡½æ•°
fn main {
  let model = { 
    page: 0, 
    search: "", 
    tag: "", 
    dark_theme: false,
    menu_open: false,
    liked_posts: [],
    posts_per_page: 6,
    current_posts_count: 4
  }
  @tea.startup(model=model, update=update, view=view)
}