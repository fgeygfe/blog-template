///| æ¶ˆæ¯ç±»å‹
enum Msg {
  ToHome
  ToPost1
  ToPost2
  Search(String) // æ–°å¢ï¼šæœç´¢æ¶ˆæ¯
  SelectTag(String) // æ–°å¢ï¼šæ ‡ç­¾é€‰æ‹©æ¶ˆæ¯
}

///| çŠ¶æ€ç±»å‹
struct Model {
  page : Int // 0:é¦–é¡µ, 1:è¯¦æƒ…1, 2:è¯¦æƒ…2
  search : String // æ–°å¢ï¼šæœç´¢å…³é”®è¯
  tag : String // æ–°å¢ï¼šå½“å‰æ ‡ç­¾
}

struct Post {
  id: Int
  emoji: String
  title: String
  author: String
  date: String
  summary: String
  tag: String
  click: Msg
}

///| æ›´æ–°å‡½æ•°
fn update(msg : Msg, model : Model) -> (Cmd[Msg], Model) {
  match msg {
    ToHome => (none(), { page: 0, search: "", tag: "" })
    ToPost1 => (none(), { page: 1, search: model.search, tag: model.tag })
    ToPost2 => (none(), { page: 2, search: model.search, tag: model.tag })
    Search(keyword) => (none(), { page: 0, search: keyword, tag: model.tag })
    SelectTag(tag) => (none(), { page: 0, search: model.search, tag: tag })
  }
}

///| é¦–é¡µè§†å›¾
fn view_home(model: Model) -> Html[Msg] {
  let posts = [
    {
      id: 1,
      emoji: "ğŸ‘©â€ğŸ’»", 
      title: "MoonBit åšå®¢ç³»ç»Ÿå¼€å‘åˆæ¢",
      author: "Zhuanz2",
      date: "2025-08-20",
      summary: "è¿™æ˜¯ç¬¬ä¸€ç¯‡åšå®¢å†…å®¹ï¼Œæ”¯æŒ Markdown æ ¼å¼ã€‚",
      tag: "MoonBit",
      click: ToPost1
    },
    {
      id: 2,
      emoji: "ğŸ¦„",
      title: "Rabbit-tea æ¡†æ¶ä»‹ç»", 
      author: "Yoorkin",
      date: "2025-08-21",
      summary: "Rabbit-tea æ˜¯ MoonBit çš„å‰ç«¯æ¡†æ¶ï¼Œé€‚åˆå¤šé¡µåº”ç”¨å¼€å‘ã€‚",
      tag: "å‰ç«¯",
      click: ToPost2
    }
  ]
  
  let tags = ["å…¨éƒ¨", "MoonBit", "å‰ç«¯"]
  
  let filtered_posts = posts.filter(fn(post) {
    (model.tag == "" || model.tag == "å…¨éƒ¨" || post.tag == model.tag) &&
    (model.search == "" || post.title.contains(model.search) || post.summary.contains(model.search))
  })

  div(
    class="min-h-screen bg-gradient-to-br from-pink-200 via-pink-100 to-white flex flex-col items-center justify-between",
    [
      div(
        class="w-full py-6 bg-gradient-to-r from-pink-400 to-pink-200 shadow-lg",
        [
          h1(
            class="text-5xl font-extrabold text-white text-center drop-shadow mb-2",
            [text("ğŸŒ¸ MoonBit åšå®¢")]
          ),
          p(
            class="text-lg text-pink-50 text-center", 
            [text("æ¬¢è¿æ¥åˆ°æ›´ç¾è§‚çš„åšå®¢é¦–é¡µï¼")]
          )
        ]
      ),
      
      // æœç´¢æ¡†
      div(class="w-full max-w-2xl px-4 mt-6 flex gap-2", [
        button(
          class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200",
          click=Search("MoonBit"),
          [text("æœç´¢: MoonBit")]
        ),
        button(
          class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200",
          click=Search("å‰ç«¯"),
          [text("æœç´¢: å‰ç«¯")]
        ),
        button(
          class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200",
          click=Search(""),
          [text("æ¸…é™¤æœç´¢")]
        )
      ]),
      
      // æ ‡ç­¾æ 
      div(
        class="w-full max-w-2xl px-4 mt-2 flex gap-2",
        tags.map(fn(tag) {
          let btn_class = if model.tag == tag {
            "bg-pink-500 text-white px-3 py-1 rounded-full"
          } else {
            "bg-pink-100 text-pink-700 px-3 py-1 rounded-full"
          }
          button(
            class=btn_class,
            click=SelectTag(tag),
            [text(tag)]
          )
        })
      ),
      
      // åšå®¢åˆ—è¡¨
      div(
        class="w-full max-w-2xl px-4 py-8 space-y-8",
        if filtered_posts.length() == 0 {
          [div(class="text-center text-pink-400 py-8", [text("æ²¡æœ‰æ‰¾åˆ°ç›¸å…³åšå®¢")])]
        } else {
          filtered_posts.map(fn(post) {
            div(
              class="bg-white rounded-2xl shadow-xl p-8 flex items-center gap-6 hover:scale-105 transition-all duration-300 border-b-2 border-pink-100",
              [
                div(class="text-4xl", [text(post.emoji)]),
                div(class="flex-1", [
                  h1(class="text-2xl font-bold mb-2 text-pink-700", [text(post.title)]),
                  p(class="text-xs text-gray-400 mb-2", [text("ä½œè€…ï¼š" + post.author + " Â· " + post.date)]),
                  p(class="text-base text-gray-600 mb-4 line-clamp-2", [text(post.summary)]),
                  div(class="mb-2", [
                    div(class="bg-pink-100 text-pink-700 px-2 py-1 rounded-full text-xs", [text(post.tag)])
                  ]),
                  button(
                    class="inline-flex items-center gap-2 px-4 py-2 bg-pink-500 text-white rounded-full shadow hover:bg-pink-600 active:scale-95 transition",
                    click=post.click,
                    [text("é˜…è¯»è¯¦æƒ…"), text("â†’")]
                  )
                ])
              ]
            )
          })
        }
      ),
      
      // åº•éƒ¨ç‰ˆæƒ
      div(
        class="w-full py-4 text-center text-xs text-pink-600 bg-pink-50 border-t border-pink-200 mt-8",
        [text("Â© 2025 MoonBit åšå®¢ Demo Â· Powered by rabbit-tea & Tailwind CSS")]
      )
    ]
  )
}

///| è¯¦æƒ…é¡µ1è§†å›¾
fn view_post1() -> Html[Msg] {
  div(class="min-h-screen bg-gradient-to-br from-pink-200 via-pink-100 to-white flex flex-col items-center", [
    div(class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-10 mt-10", [
      div(class="flex items-center gap-4 mb-6", [
        div(class="text-3xl", [text("ğŸ‘©â€ğŸ’»")]),
        h1(class="text-3xl font-bold text-pink-700", [text("MoonBit åšå®¢ç³»ç»Ÿå¼€å‘åˆæ¢")])
      ]),
      p(class="text-xs text-gray-400 mb-2", [text("ä½œè€…ï¼šZhuanz2 Â· 2025-08-20")]),
      div(class="border-b border-pink-100 mb-6", [text("")]),
      div(class="prose prose-pink max-w-none text-gray-700 mb-8", [text("è¿™é‡Œæ˜¯åšå®¢æ­£æ–‡å†…å®¹ã€‚")]),
      button(class="inline-flex items-center gap-2 px-4 py-2 bg-pink-500 text-white rounded-full shadow hover:bg-pink-600 active:scale-95 transition", click=ToHome, [text("è¿”å›é¦–é¡µ"), text("ğŸ ")])
    ]),
    div(class="w-full py-4 text-center text-xs text-pink-600 bg-pink-50 border-t border-pink-200 mt-8", [
      text("Â© 2025 MoonBit åšå®¢ Demo Â· Powered by rabbit-tea & Tailwind CSS")
    ])
  ])
}

///| è¯¦æƒ…é¡µ2è§†å›¾
fn view_post2() -> Html[Msg] {
  div(class="min-h-screen bg-gradient-to-br from-pink-200 via-pink-100 to-white flex flex-col items-center", [
    div(class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-10 mt-10", [
      div(class="flex items-center gap-4 mb-6", [
        div(class="text-3xl", [text("ğŸ¦„")]),
        h1(class="text-3xl font-bold text-pink-700", [text("Rabbit-tea æ¡†æ¶ä»‹ç»")])
      ]),
      p(class="text-xs text-gray-400 mb-2", [text("ä½œè€…ï¼šYoorkin Â· 2025-08-21")]),
      div(class="border-b border-pink-100 mb-6", [text("")]),
      div(class="prose prose-pink max-w-none text-gray-700 mb-8", [text("è¿™é‡Œæ˜¯ Rabbit-tea ä»‹ç»æ­£æ–‡å†…å®¹ã€‚")]),
      button(class="inline-flex items-center gap-2 px-4 py-2 bg-pink-500 text-white rounded-full shadow hover:bg-pink-600 active:scale-95 transition", click=ToHome, [text("è¿”å›é¦–é¡µ"), text("ğŸ ")])
    ]),
    div(class="w-full py-4 text-center text-xs text-pink-600 bg-pink-50 border-t border-pink-200 mt-8", [
      text("Â© 2025 MoonBit åšå®¢ Demo Â· Powered by rabbit-tea & Tailwind CSS")
    ])
  ])
}

///| æ€»è§†å›¾
fn view(model : Model) -> Html[Msg] {
  match model.page {
    0 => view_home(model)
    1 => view_post1()
    2 => view_post2()
    _ => div(class="", [text("é¡µé¢ä¸å­˜åœ¨")])
  }
}

fn main {
  let model = { page: 0, search: "", tag: "" }
  @tea.startup(model=model, update=update, view=view)
}